<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sports Island | é ç´„ä¸­å¿ƒ V7.2</title>
    <!-- å¼•å…¥ç³»çµ±è³‡æº -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --brand-green: #06C755; --text-black: #000000; }
        body { 
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            background-color: #FFFFFF; color: var(--text-black); -webkit-font-smoothing: antialiased; 
        }
        
        /* é é¢åˆ†æµæ§åˆ¶ */
        .page-view { display: none; min-height: 100vh; }
        .page-view.active { display: block; animation: viewIn 0.3s ease-out; }
        @keyframes viewIn { from { opacity: 0; transform: translateX(10px); } to { opacity: 1; transform: translateX(0); } }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* æ»¿ç‰ˆç„¡æ¡†æ¢åˆ— */
        .list-row { display: flex; padding: 1.5rem 1rem; border-bottom: 1px solid #F3F4F6; gap: 1rem; align-items: flex-start; }
        .list-row:active { background-color: #F9FAFB; }

        /* æœƒå“¡å°ˆå€å¤§å…¥å£ */
        .menu-item { display: flex; align-items: center; justify-content: space-between; padding: 1.75rem 1.25rem; border-bottom: 2px solid #F3F4F6; width: 100%; }
        .menu-item:active { background-color: #F9FAFB; }

        /* å°ˆæ¥­è¡¨å–®è¼¸å…¥æ¡†ï¼šå»æ¡†ã€åŠ ç²— */
        .input-premium {
            width: 100%; padding: 1.25rem; border-bottom: 2px solid #000000;
            font-size: 1.25rem; font-weight: 800; color: #000000; outline: none; background-color: transparent;
        }
        .input-premium:focus { border-bottom-color: var(--brand-green); }

        /* å°è¦½åˆ—ï¼šç´”é»‘èˆ‡ç¶ è‰²ï¼Œçµ•ç„¡ç°éš */
        .nav-active { color: var(--brand-green) !important; font-weight: 900; }
        .nav-inactive { color: #000000 !important; font-weight: 900; }

        #msgBox { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #000000; color: white; padding: 2.5rem; border-radius: 2.5rem; z-index: 3000; width: 85%; text-align: center; }
        #loadOverlay { position: fixed; inset: 0; background: white; z-index: 4000; display: flex; flex-direction: column; items: center; justify-content: center; }
    </style>
</head>
<body class="pb-24">

    <!-- å…¨è¢å¹•è®€å– -->
    <div id="loadOverlay">
        <div class="w-20 h-20 bg-[#06C755] rounded-2xl flex items-center justify-center font-bold text-white text-5xl italic animate-bounce shadow-2xl">S</div>
        <p class="mt-8 text-2xl font-black italic text-black animate-pulse uppercase tracking-widest">Sport Island Syncing</p>
    </div>

    <!-- è¨Šæ¯æç¤ºç›’ -->
    <div id="msgBox">
        <div id="msgIcon" class="mb-5 flex justify-center"></div>
        <p id="msgText" class="text-2xl font-black italic leading-snug"></p>
        <button onclick="closeMsg()" class="mt-10 w-full py-5 bg-[#06C755] text-white rounded-2xl font-black uppercase text-xl">ç¢ºèª</button>
    </div>

    <!-- 1. [ç¨ç«‹è¨»å†Šåˆ†æµé é¢] - ä¾ç…§æ‚¨çš„æ–‡ä»¶è¦æ ¼é‡æ§‹ -->
    <div id="viewRegister" class="page-view px-8 pt-16 bg-white overflow-y-auto pb-10">
        <div class="mb-10">
            <h2 class="text-4xl font-black italic uppercase mb-2 tracking-tighter text-black">Member Profile</h2>
            <div class="h-2 w-20 bg-[#06C755] rounded-full mb-6"></div>
            <p class="text-lg font-black text-black leading-tight">æˆå“¡è³‡æ–™è¨­å®š</p>
        </div>
        
        <form onsubmit="submitRegistration(event)" class="space-y-10 pb-10">
            <!-- å®¶é•·è³‡è¨Š -->
            <div class="space-y-6">
                <div><label class="block text-xs font-black uppercase tracking-widest text-black opacity-50 mb-1">Parent Name / å®¶é•·å§“å</label><input type="text" id="parentName" class="input-premium" required placeholder="å¡«å¯«è¯ç¹«å®¶é•·å§“å"></div>
                <div><label class="block text-xs font-black uppercase tracking-widest text-black opacity-50 mb-1">Contact / è¯ç¹«é›»è©±</label><input type="tel" id="parentPhone" class="input-premium" required placeholder="09XX-XXX-XXX"></div>
            </div>

            <div class="border-t-4 border-black w-10"></div>

            <!-- å­¸å“¡è³‡è¨Š -->
            <div class="space-y-6">
                <div><label class="block text-xs font-black uppercase tracking-widest text-black opacity-50 mb-1">Student Name / å­¸å“¡å§“å</label><input type="text" id="studentName" class="input-premium" required placeholder="å¡«å¯«åƒåŠ å­¸å“¡å§“å"></div>
                <div>
                    <label class="block text-xs font-black uppercase tracking-widest text-black opacity-50 mb-3">Gender / å­¸å“¡æ€§åˆ¥</label>
                    <div class="flex gap-10">
                        <label class="flex items-center gap-2 font-black text-xl"><input type="radio" name="gender" value="ç”·" checked class="w-6 h-6 accent-[#06C755]"> ç”·ç”Ÿ</label>
                        <label class="flex items-center gap-2 font-black text-xl"><input type="radio" name="gender" value="å¥³" class="w-6 h-6 accent-[#06C755]"> å¥³ç”Ÿ</label>
                    </div>
                </div>
                <div><label class="block text-xs font-black uppercase tracking-widest text-black opacity-50 mb-1">Birthday / å‡ºç”Ÿæ—¥æœŸ</label><input type="date" id="birthday" class="input-premium" required></div>
                <div class="grid grid-cols-2 gap-6">
                    <div><label class="block text-xs font-black uppercase tracking-widest text-black opacity-50 mb-1">School / å­¸æ ¡</label><input type="text" id="school" class="input-premium" placeholder="ä¾‹å¦‚ï¼šæ–°ç«¹åœ‹å°"></div>
                    <div>
                        <label class="block text-xs font-black uppercase tracking-widest text-black opacity-50 mb-1">Grade / å¹´ç´š</label>
                        <select id="grade" class="input-premium" required>
                            <option value="">è«‹é¸æ“‡</option>
                            <option value="å¹¼å…’çµ„">å¹¼å…’çµ„</option>
                            <option value="ä½å¹´ç´š">åœ‹å°ä½å¹´ç´š</option>
                            <option value="ä¸­å¹´ç´š">åœ‹å°ä¸­å¹´ç´š</option>
                            <option value="é«˜å¹´ç´š">åœ‹å°é«˜å¹´ç´š</option>
                            <option value="åœ‹é«˜ä¸­">åœ‹é«˜ä¸­</option>
                            <option value="æˆäºº">æˆäºº</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="pt-8">
                <button type="submit" class="w-full py-7 bg-black text-[#06C755] rounded-3xl font-black text-2xl shadow-2xl uppercase active:scale-95 transition-all">å„²å­˜ä¸¦ç¢ºèªè³‡æ–™ ğŸ’¾</button>
                <button type="button" onclick="backToApp()" class="w-full mt-4 py-4 font-black text-black underline uppercase">å–æ¶ˆè¿”å›</button>
            </div>
        </form>
    </div>

    <!-- 2. [ä¸»ç³»çµ±è¦–åœ–] -->
    <div id="viewApp" class="page-view">
        <header class="sticky top-0 z-50 bg-white border-b-2 border-gray-100 px-6 py-5 flex items-center justify-between">
            <div class="flex items-center gap-3"><div class="w-10 h-10 bg-[#06C755] rounded-xl flex items-center justify-center font-bold text-white text-2xl italic">S</div><h1 class="text-2xl font-black italic tracking-tighter uppercase font-sans text-black">Sports Island</h1></div>
            <div class="w-11 h-11 rounded-full border-2 border-white shadow-md overflow-hidden bg-slate-100"><img id="userImg" src="" class="w-full h-full object-cover"></div>
        </header>

        <!-- Tab: é¦–é  -->
        <div id="tabHome" class="tab-content active">
            <div class="relative w-full h-56 overflow-hidden border-b-2 border-gray-100"><img src="https://aiwe.cc/wp-content/uploads/2025/12/3486bc19dc6317e16bf4f1449ec52ae4.jpg" class="w-full h-full object-cover"></div>
            <div class="grid grid-cols-2 gap-0 border-b-2 border-gray-200">
                <button onclick="changeTab('courses')" class="bg-white py-8 flex items-center justify-center gap-4 active:bg-gray-50 border-r border-gray-100 font-black text-lg text-black"><i data-lucide="calendar-plus" class="w-7 h-7 text-green-500"></i>èª²ç¨‹é ç´„</button>
                <button onclick="changeTab('member')" class="bg-white py-8 flex items-center justify-center gap-4 active:bg-gray-50 font-black text-lg text-black"><i data-lucide="user-check" class="w-7 h-7 text-blue-500"></i>æœƒå“¡ä¸­å¿ƒ</button>
            </div>
            <div class="mt-8 px-8 text-black"><h3 class="text-xs font-black uppercase tracking-[0.2em] mb-8 italic"><i data-lucide="megaphone" class="w-6 h-6 text-amber-500 inline mr-2"></i>æœ€æ–°å…¬å‘Š</h3><div id="annList" class="divide-y divide-gray-100 border-t border-gray-100"></div></div>
            <div id="homeList" class="border-t border-gray-100 pb-12"></div>
        </div>

        <!-- Tab: é ç´„æ¸…å–® -->
        <div id="tabCourses" class="tab-content">
            <div class="p-6 bg-gray-50 border-b-2 border-gray-200 flex items-center gap-5"><i data-lucide="search" class="w-7 h-7 text-black font-black"></i><input type="text" placeholder="æœå°‹æ•™ç·´æˆ–åœ°é»..." class="flex-1 outline-none text-xl bg-transparent font-black text-black"></div>
            <div id="fullList" class="divide-y divide-gray-100"></div>
        </div>

        <!-- Tab: æœƒå“¡å°ˆå€ (ç¨ç«‹å…©å¤§ ITEM) -->
        <div id="tabMember" class="tab-content animate-in slide-in-from-bottom px-6 pt-10">
            <div class="bg-black p-12 rounded-[3.5rem] text-white shadow-2xl relative overflow-hidden mb-12 border-4 border-gray-950">
                <div class="absolute -right-12 -top-12 w-64 h-64 bg-green-500/10 rounded-full blur-[80px]"></div>
                <h2 id="userName" class="text-5xl font-black italic uppercase font-sans mb-14 tracking-tighter">--</h2>
                <div class="grid grid-cols-2 border-t border-white/10 pt-10 gap-8">
                    <div><p class="text-xs font-black text-gray-500 uppercase mb-2 tracking-widest italic">é»æ•¸é¤˜é¡</p><p id="userPoints" class="text-5xl font-black text-[#06C755] font-sans tracking-tighter">--</p></div>
                    <div><p class="text-xs font-black text-gray-500 uppercase mb-2 tracking-widest italic">ç­‰ç´šæ¬Šé™</p><p id="userLevel" class="text-5xl font-black text-blue-400 font-sans tracking-tighter">--</p></div>
                </div>
            </div>
            <div class="flex flex-col w-full border-t-2 border-gray-100">
                <button onclick="switchView('viewRegister')" class="menu-item">
                    <div class="flex items-center gap-6">
                        <div class="w-16 h-16 bg-green-50 text-green-600 rounded-2xl flex items-center justify-center shadow-inner"><i data-lucide="user-cog" class="w-9 h-9"></i></div>
                        <div class="text-left"><p class="text-2xl font-black text-black">1. æœƒå“¡è¨»å†Š</p><p class="text-xs font-black text-black opacity-30 italic">Update Information</p></div>
                    </div>
                    <i data-lucide="chevron-right" class="w-8 h-8 text-black opacity-30"></i>
                </button>
                <button onclick="switchView('viewHistory')" class="menu-item">
                    <div class="flex items-center gap-6">
                        <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center shadow-inner"><i data-lucide="history" class="w-9 h-9"></i></div>
                        <div class="text-left"><p class="text-2xl font-black text-black">2. ä¸Šèª²ç´€éŒ„</p><p class="text-xs font-black text-black opacity-40 italic">Training History</p></div>
                    </div>
                    <i data-lucide="chevron-right" class="w-8 h-8 text-black opacity-30"></i>
                </button>
            </div>
        </div>

        <nav id="mainNav" class="fixed bottom-0 inset-x-0 bg-white border-t-4 border-gray-100 h-28 flex items-center justify-around z-50 px-8 shadow-2xl">
            <button onclick="changeTab('home')" id="navHome" class="flex flex-col items-center gap-2 nav-active transition-all"><i data-lucide="home" class="w-9 h-9"></i><span class="text-[11px] font-black uppercase tracking-widest">é¦–é </span></button>
            <button onclick="changeTab('courses')" id="navCourses" class="flex flex-col items-center gap-2 nav-inactive transition-all"><i data-lucide="calendar" class="w-9 h-9"></i><span class="text-[11px] font-black uppercase tracking-widest">é ç´„</span></button>
            <button onclick="changeTab('member')" id="navMember" class="flex flex-col items-center gap-2 nav-inactive transition-all"><i data-lucide="user" class="w-9 h-9"></i><span class="text-[11px] font-black uppercase tracking-widest">æˆ‘çš„</span></button>
        </nav>
    </div>

    <!-- 3. [ç¨ç«‹ä¸Šèª²ç´€éŒ„è¦–åœ–] -->
    <div id="viewHistory" class="page-view p-8 bg-white overflow-y-auto">
        <button onclick="backToApp()" class="flex items-center gap-4 font-black text-2xl mb-12 text-black"><i data-lucide="chevron-left" class="w-8 h-8"></i> è¿”å›</button>
        <h3 class="text-5xl font-black italic uppercase tracking-tighter mb-10 border-b-8 border-[#06C755] w-fit">HISTORY</h3>
        <div id="historyList" class="flex flex-col items-center py-32 opacity-40 italic font-black uppercase tracking-widest text-black"><i data-lucide="scroll-text" class="w-16 h-16 mb-4"></i>ç›®å‰å°šæœªæœ‰ç´€éŒ„</div>
    </div>

    <script>
        const PROXY_URL = 'https://curly-feather-9ac5.wetw-net3.workers.dev/';
        const LIFF_ID = '2008786875-7COWtgtL';
        let user = null; let activeCourses = [];

        window.onload = async () => {
            lucide.createIcons();
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) liff.login();
                else {
                    const profile = await liff.getProfile();
                    await syncUser(profile);
                    await syncAppData();
                }
            } catch (err) { console.error(err); }
        };

        async function syncUser(profile) {
            const res = await fetch(`${PROXY_URL}?action=userLogin&userId=${profile.userId}&displayName=${profile.displayName}`);
            const data = await res.json();
            document.getElementById('loadOverlay').style.display = 'none';
            if (data.success) {
                user = data.user;
                // åˆ†æµé‚è¼¯ï¼šå®¶é•·æ‰‹æ©Ÿæˆ–å­¸å“¡å§“åç‚ºç©ºï¼Œå¼·åˆ¶è¨»å†Š
                if (!user.parentPhone || !user.birthday) {
                    switchView('viewRegister');
                    document.getElementById('studentName').value = user.studentName || '';
                } else {
                    switchView('viewApp');
                    updateUI(profile);
                }
            }
        }

        async function submitRegistration(e) {
            e.preventDefault();
            const payload = {
                userId: user.userId,
                parentName: document.getElementById('parentName').value.trim(),
                parentPhone: document.getElementById('parentPhone').value.trim(),
                studentName: document.getElementById('studentName').value.trim(),
                gender: document.querySelector('input[name="gender"]:checked').value,
                birthday: document.getElementById('birthday').value,
                school: document.getElementById('school').value.trim(),
                grade: document.getElementById('grade').value
            };
            
            showMsg('loader', 'è³‡æ–™åŒæ­¥ä¸­...');
            const q = new URLSearchParams(payload).toString();
            const res = await fetch(`${PROXY_URL}?action=updateRegistration&${q}`);
            const result = await res.json();
            if(result.success) { 
                showMsg('check-circle', 'è¨»å†ŠæˆåŠŸï¼å³å°‡é€²å…¥'); 
                setTimeout(() => location.reload(), 1200); 
            }
        }

        function updateUI(profile) {
            document.getElementById('userName').innerText = user.studentName;
            document.getElementById('userPoints').innerText = user.points;
            document.getElementById('userLevel').innerText = user.level;
            document.getElementById('userImg').src = profile.pictureUrl || '';
        }

        function switchView(id) { document.querySelectorAll('.page-view').forEach(v => v.classList.remove('active')); document.getElementById(id).classList.add('active'); lucide.createIcons(); }
        function backToApp() { switchView('viewApp'); }
        function changeTab(tabId) { document.querySelectorAll('.tab-content').forEach(p => p.classList.remove('active')); document.getElementById('tab' + tabId.charAt(0).toUpperCase() + tabId.slice(1)).classList.add('active'); document.querySelectorAll('nav button').forEach(b => { b.classList.remove('nav-active'); b.classList.add('nav-inactive'); }); document.getElementById('nav' + tabId.charAt(0).toUpperCase() + tabId.slice(1)).classList.replace('nav-inactive', 'nav-active'); lucide.createIcons(); window.scrollTo({ top: 0, behavior: 'smooth' }); }

        async function syncAppData() {
            try {
                const [annR, crsR] = await Promise.all([ fetch(`${PROXY_URL}?action=getAnnouncements`), fetch(`${PROXY_URL}?action=getCourses`) ]);
                const anns = await annR.json(); const crs = await crsR.json();
                activeCourses = crs;
                document.getElementById('annList').innerHTML = anns.slice(0,3).reverse().map(a => `<div class="py-6 flex items-start gap-4 active:bg-gray-50"><div class="w-3 h-3 rounded-full bg-[#06C755] mt-2 shrink-0"></div><p class="text-xl font-black text-black leading-snug">${a.title}</p></div>`).join('');
                const renderRow = (c) => `
                    <div class="list-row">
                        <div class="w-32 h-32 shrink-0 rounded-2xl overflow-hidden bg-gray-50 border-2 border-gray-100 relative"><img src="${c.coverUrl || 'https://via.placeholder.com/400'}" class="w-full h-full object-cover"></div>
                        <div class="flex-1 min-w-0 flex flex-col justify-between self-stretch">
                            <div>
                                <h4 class="font-black text-black text-2xl truncate uppercase mb-1 tracking-tighter">${c.name}</h4>
                                <div class="flex items-center gap-1.5 text-base font-black text-red-600 mb-1.5 italic font-sans"><i data-lucide="map-pin" class="w-4 h-4 text-red-600"></i> ${c.venue || 'å ´é¤¨æœªå®š'}</div>
                                <div class="text-sm font-black text-black flex items-center gap-4 italic"><span class="flex items-center gap-1.5"><i data-lucide="user" class="w-4 h-4 text-blue-600"></i> ${c.coach}</span><span>${c.date.split('T')[0]} ${c.time.split(':').slice(0,2).join(':')}</span></div>
                            </div>
                            <div class="flex items-end justify-between mt-4">
                                <span class="text-3xl font-black text-red-600">$${c.earlyPrice || c.price}</span>
                                <button class="bg-[#06C755] text-white px-8 py-3.5 rounded-2xl text-sm font-black shadow-xl uppercase active:scale-90 transition-all">é ç´„</button>
                            </div>
                        </div>
                    </div>`;
                document.getElementById('homeList').innerHTML = crs.slice(0,5).map(c => renderRow(c)).join('');
                document.getElementById('fullList').innerHTML = crs.map(c => renderRow(c)).join(''); lucide.createIcons();
            } catch(e) { console.error("Sync Error", e); }
        }

        function showMsg(icon, text) { const box = document.getElementById('msgBox'); document.getElementById('msgIcon').innerHTML = `<i data-lucide="${icon}" class="w-20 h-20 text-[#06C755]"></i>`; document.getElementById('msgText').innerText = text; box.style.display = 'block'; lucide.createIcons(); }
        function closeMsg() { document.getElementById('msgBox').style.display = 'none'; }
    </script>
</body>
</html>
